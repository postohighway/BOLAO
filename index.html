<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Juliano — Painel do Dono (3 Unidades + Nota a Prazo)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root{
      --bg:#f4f6f8; --card:#fff; --text:#111; --muted:#666;
      --primary:#0b7285; --danger:#c92a2a; --gray:#868e96; --ok:#2b8a3e;
      --shadow:0 1px 3px rgba(0,0,0,.12); --radius:14px;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--text)}
    header{background:#000;color:#fff;text-align:center;padding:14px 10px}
    header .t1{font-weight:1000;letter-spacing:1px;text-transform:uppercase;font-size:16px}
    header .t2{opacity:.85;font-size:12px;margin-top:4px}
    .wrap{max-width:1040px;margin:0 auto;padding:12px}
    .card{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);padding:12px 14px;margin-bottom:12px}
    label{font-size:13px;font-weight:900;display:block;margin:8px 0 6px}
    input,select,textarea{width:100%;padding:12px;border-radius:12px;border:1px solid #d9dde3;font-size:16px;background:#fff}
    textarea{min-height:140px;resize:vertical}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .row>div{flex:1;min-width:210px}
    .btn{border:0;border-radius:12px;padding:12px 14px;font-weight:1000;cursor:pointer}
    .btn.primary{background:var(--primary);color:#fff}
    .btn.gray{background:var(--gray);color:#fff}
    .btn.danger{background:var(--danger);color:#fff}
    .btn.ok{background:var(--ok);color:#fff}
    .btn.full{width:100%}
    .small{font-size:12px;color:var(--muted);line-height:1.35}
    .pill{display:inline-block;padding:3px 10px;border-radius:999px;background:#e7f5ff;color:var(--primary);font-weight:900;font-size:12px}
    .box{background:#f8f9fa;border:1px solid #e9ecef;border-radius:12px;padding:10px;margin-top:8px}
    .divider{height:1px;background:#e9ecef;margin:12px 0}
    .mono{font-family:ui-monospace, Menlo, Consolas, monospace}
    table{width:100%;border-collapse:separate;border-spacing:0;overflow:hidden;border-radius:12px;border:1px solid #e9ecef}
    th,td{padding:10px;border-bottom:1px solid #e9ecef;text-align:left;font-size:13px}
    th{background:#f1f3f5;font-weight:1000}
    tr:last-child td{border-bottom:0}
    .kpi{display:grid;grid-template-columns:repeat(3, minmax(0, 1fr));gap:10px}
    .kpi .k{background:#fff;border:1px solid #e9ecef;border-radius:12px;padding:10px}
    .k .h{font-size:12px;color:var(--muted);font-weight:900}
    .k .v{font-size:18px;font-weight:1000;margin-top:4px}
    .tag{display:inline-block;padding:2px 8px;border-radius:999px;background:#f1f3f5;font-weight:1000;font-size:12px}
    .right{display:flex;gap:8px;flex-wrap:wrap}
    .right .btn{flex:1;min-width:180px}
    .msg{display:none;margin-top:8px;font-weight:1000;font-size:13px}
    .msg.ok{color:var(--ok)}
    .msg.bad{color:var(--danger)}
    details summary{cursor:pointer;font-weight:1000}
  </style>
</head>
<body>
<header>
  <div class="t1">JULIANO — CONSOLIDADO 3 UNIDADES + NOTA A PRAZO</div>
  <div class="t2">Cole a mensagem do WhatsApp de cada unidade → IMPORTAR → consulte por dia/período + saldos a prazo por cliente.</div>
</header>

<div class="wrap">

  <div class="card">
    <div class="pill">1) IMPORTAR FECHAMENTO (COLA DO WHATSAPP)</div>
    <div class="small">
      Passo: WhatsApp → segurar mensagem → <b>Copiar</b> → voltar aqui → <b>Colar</b> → <b>IMPORTAR</b>.<br>
      Aceita linhas do tipo: UNIDADE, DATA, CARROS, PIX, DINHEIRO, CREDITO, DEBITO, e várias linhas <b>PRAZO:</b>.
    </div>

    <label>Cole aqui a mensagem (uma unidade por vez)</label>
    <textarea id="paste" class="mono" placeholder="Cole aqui..."></textarea>

    <div class="right" style="margin-top:8px">
      <button class="btn primary" id="btnImport">IMPORTAR</button>
      <button class="btn gray" id="btnClearPaste">LIMPAR CAIXA</button>
    </div>

    <div class="row" style="margin-top:8px">
      <div>
        <button class="btn gray full" id="btnExportJson">EXPORTAR BACKUP (JSON)</button>
      </div>
      <div>
        <label style="margin-top:0">IMPORTAR BACKUP (JSON)</label>
        <input type="file" id="importJsonFile" accept="application/json" />
      </div>
      <div>
        <button class="btn danger full" id="btnResetAll">ZERAR TUDO (CUIDADO)</button>
      </div>
    </div>

    <div id="msg" class="msg"></div>

    <details style="margin-top:10px">
      <summary>Ver formato esperado (para identificar mensagem errada)</summary>
      <div class="box mono small">
UNIDADE: FAVORITO<br>
DATA: 2026-02-23<br>
CARROS: 27<br>
PIX: 1230.00<br>
DINHEIRO: 420.00<br>
CREDITO: 980.00<br>
DEBITO: 350.00<br>
PRAZO: CLIENTE=FAZENDA SANTA CLARA; TIPO=VENDA; VALOR=50.00; OBS=Lavagem caminhonete<br>
PRAZO: CLIENTE=FAZENDA SANTA CLARA; TIPO=PAGAMENTO; VALOR=30.00; OBS=PIX
      </div>
    </details>
  </div>

  <div class="card">
    <div class="pill">2) CONSULTA — DIA OU PERÍODO</div>

    <div class="row">
      <div>
        <label>Modo</label>
        <select id="mode">
          <option value="DIA">Dia</option>
          <option value="PERIODO">Período</option>
        </select>
      </div>
      <div id="diaBox">
        <label>Data</label>
        <input type="date" id="qDate" />
      </div>
      <div id="periodoBox" style="display:none">
        <label>Início</label>
        <input type="date" id="qStart" />
      </div>
      <div id="periodoBox2" style="display:none">
        <label>Fim</label>
        <input type="date" id="qEnd" />
      </div>
    </div>

    <div class="right" style="margin-top:8px">
      <button class="btn ok" id="btnRun">APURAR</button>
      <button class="btn gray" id="btnToday">HOJE</button>
    </div>

    <div class="divider"></div>

    <div class="pill">RESULTADO — CONSOLIDADO</div>
    <div class="kpi" style="margin-top:8px">
      <div class="k"><div class="h">Carros (total)</div><div class="v" id="kCars">0</div></div>
      <div class="k"><div class="h">Recebido (PIX+Dinheiro+Crédito+Débito)</div><div class="v" id="kTotal">R$ 0,00</div></div>
      <div class="k"><div class="h">Nota a prazo (movimentação no período)</div><div class="v" id="kPrazoMov">R$ 0,00</div></div>
    </div>

    <div class="box" style="margin-top:10px">
      <b>Quebra por forma de pagamento (consolidado):</b>
      <div class="row" style="margin-top:8px">
        <div class="k"><div class="h">PIX</div><div class="v" id="kPix">R$ 0,00</div></div>
        <div class="k"><div class="h">Dinheiro</div><div class="v" id="kCash">R$ 0,00</div></div>
        <div class="k"><div class="h">Crédito</div><div class="v" id="kCredit">R$ 0,00</div></div>
        <div class="k"><div class="h">Débito</div><div class="v" id="kDebit">R$ 0,00</div></div>
      </div>
    </div>

    <div class="divider"></div>

    <div class="pill">RESULTADO — POR UNIDADE</div>
    <div class="box" style="margin-top:8px">
      <table>
        <thead>
          <tr>
            <th>Unidade</th>
            <th>Carros</th>
            <th>PIX</th>
            <th>Dinheiro</th>
            <th>Crédito</th>
            <th>Débito</th>
            <th>Total</th>
          </tr>
        </thead>
        <tbody id="tblUnits"></tbody>
      </table>
    </div>

    <div class="divider"></div>

    <div class="pill">LANÇAMENTOS IMPORTADOS (editar/excluir se veio errado)</div>
    <div class="small">Você pode excluir um fechamento importado errado (por unidade+data) e importar de novo.</div>
    <div class="box" style="margin-top:8px">
      <table>
        <thead>
          <tr>
            <th>Data</th>
            <th>Unidade</th>
            <th>Carros</th>
            <th>Total</th>
            <th>Ações</th>
          </tr>
        </thead>
        <tbody id="tblEntries"></tbody>
      </table>
    </div>

  </div>

  <div class="card">
    <div class="pill">3) NOTA A PRAZO — CONTAS POR CLIENTE</div>
    <div class="small">
      Aqui é a “conta corrente” do cliente. <b>VENDA</b> soma (cliente devendo). <b>PAGAMENTO</b> subtrai (abatimento).
    </div>

    <div class="row" style="margin-top:8px">
      <div>
        <label>Filtrar por unidade</label>
        <select id="fUnit">
          <option value="TODAS">Todas</option>
          <option value="FAVORITO">Favorito</option>
          <option value="PREFERIDO">Preferido</option>
          <option value="PREDILETO">Predileto</option>
        </select>
      </div>
      <div>
        <label>Buscar cliente</label>
        <input id="fClient" placeholder="Digite parte do nome..." />
      </div>
      <div>
        <label>Mostrar</label>
        <select id="fSaldo">
          <option value="TODOS">Todos</option>
          <option value="DEVENDO">Somente devendo (saldo > 0)</option>
          <option value="QUITADO">Somente quitado (saldo = 0)</option>
        </select>
      </div>
    </div>

    <div class="box" style="margin-top:8px">
      <table>
        <thead>
          <tr>
            <th>Cliente</th>
            <th>Unidade</th>
            <th>Saldo atual</th>
            <th>Última movimentação</th>
          </tr>
        </thead>
        <tbody id="tblPrazo"></tbody>
      </table>
    </div>

    <details style="margin-top:10px">
      <summary>Ver extrato de um cliente (digite o nome exato e clique)</summary>
      <div class="small">Clique numa linha da tabela acima para abrir o extrato do cliente.</div>
      <div class="box" id="clientStatementBox" style="display:none">
        <div><b>Cliente:</b> <span id="stClient" class="mono"></span></div>
        <div><b>Unidade:</b> <span id="stUnit" class="mono"></span></div>
        <div class="divider"></div>
        <table>
          <thead>
            <tr>
              <th>Data</th>
              <th>Tipo</th>
              <th>Valor</th>
              <th>Obs</th>
              <th>Origem</th>
            </tr>
          </thead>
          <tbody id="tblStatement"></tbody>
        </table>
        <div class="divider"></div>
        <button class="btn danger full" id="btnClearClient">Zerar conta deste cliente (CUIDADO)</button>
      </div>
    </details>

  </div>

</div>

<script>
(function(){
  const STORE_KEY = "juliano_painel_v1";
  const UNITS = ["FAVORITO","PREFERIDO","PREDILETO"];

  // DB shape:
  // db.entries: { [id]: {id, unit, date, cars, pix, cash, credit, debit, total, raw, createdAt } }
  // db.prazoTx:  [ {id, unit, date, client, type, value, obs, originEntryId, createdAt} ]
  function loadDB(){
    const raw = localStorage.getItem(STORE_KEY);
    if(!raw) return { entries:{}, prazoTx:[] };
    try{
      const j = JSON.parse(raw);
      if(!j.entries) j.entries = {};
      if(!Array.isArray(j.prazoTx)) j.prazoTx = [];
      return j;
    }catch(e){
      return { entries:{}, prazoTx:[] };
    }
  }
  function saveDB(db){ localStorage.setItem(STORE_KEY, JSON.stringify(db)); }

  function el(id){ return document.getElementById(id); }
  function pad2(n){ return String(n).padStart(2,"0"); }
  function todayISO(){
    const d=new Date();
    return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
  }
  function fmtMoney(n){
    n = Number(n||0);
    return "R$ " + n.toFixed(2).replace(".",",");
  }
  function toNum(s){
    if(s==null) return null;
    const t = String(s).trim().replace(",",".");
    if(t==="") return null;
    const n = Number(t);
    return isNaN(n) ? null : n;
  }
  function normalizeUnit(u){
    if(!u) return null;
    const up = String(u).trim().toUpperCase();
    if(UNITS.includes(up)) return up;
    return null;
  }
  function normalizeClient(c){
    return String(c||"").trim().replace(/\s+/g," ");
  }
  function msg(text, ok=true){
    const m = el("msg");
    m.style.display = "block";
    m.className = "msg " + (ok ? "ok" : "bad");
    m.textContent = text;
    setTimeout(()=> m.style.display="none", 3500);
  }

  // Parse incoming WhatsApp message
  function parseMessage(raw){
    // Accept either "KEY: value" lines or slight variations.
    const lines = String(raw||"")
      .split(/\r?\n/)
      .map(x=>x.trim())
      .filter(x=>x.length);

    const data = { unit:null, date:null, cars:null, pix:null, cash:null, credit:null, debit:null, prazo:[] };

    for(const line of lines){
      const up = line.toUpperCase();

      // PRAZO line
      if(up.startsWith("PRAZO:")){
        // expected: PRAZO: CLIENTE=...; TIPO=VENDA|PAGAMENTO; VALOR=12.34; OBS=...
        const body = line.substring(line.indexOf(":")+1).trim();
        const parts = body.split(";").map(p=>p.trim()).filter(Boolean);
        const obj = { client:"", type:"", value:null, obs:"" };

        for(const p of parts){
          const idx = p.indexOf("=");
          if(idx===-1) continue;
          const k = p.substring(0, idx).trim().toUpperCase();
          const v = p.substring(idx+1).trim();
          if(k==="CLIENTE") obj.client = normalizeClient(v);
          if(k==="TIPO") obj.type = String(v||"").trim().toUpperCase();
          if(k==="VALOR") obj.value = toNum(v);
          if(k==="OBS") obj.obs = String(v||"").trim();
        }

        if(!obj.client || !["VENDA","PAGAMENTO"].includes(obj.type) || obj.value==null || obj.value<=0){
          // ignore invalid prazo line, but keep a trace
          data.prazo.push({ _invalid:true, raw: line });
        }else{
          data.prazo.push(obj);
        }
        continue;
      }

      // key:value lines
      const m = line.match(/^([A-Za-zÇÃÕÊÉÍÓÚÁÜÂÔà-ÿ\s]+)\s*:\s*(.+)$/);
      if(!m) continue;
      const key = m[1].trim().toUpperCase();
      const val = m[2].trim();

      if(key==="UNIDADE") data.unit = normalizeUnit(val);
      else if(key==="DATA") data.date = val; // expecting YYYY-MM-DD
      else if(key==="CARROS") data.cars = Math.round(toNum(val));
      else if(key==="PIX") data.pix = toNum(val);
      else if(key==="DINHEIRO") data.cash = toNum(val);
      else if(key==="CREDITO" || key==="CRÉDITO") data.credit = toNum(val);
      else if(key==="DEBITO" || key==="DÉBITO") data.debit = toNum(val);
    }

    return data;
  }

  function makeEntryId(unit, date){
    return `${unit}__${date}`;
  }

  function validateParsed(p){
    if(!p.unit) return "UNIDADE inválida (use FAVORITO/PREFERIDO/PREDILETO).";
    if(!p.date || !/^\d{4}-\d{2}-\d{2}$/.test(p.date)) return "DATA inválida (formato YYYY-MM-DD).";
    const fields = ["cars","pix","cash","credit","debit"];
    for(const f of fields){
      if(p[f]==null || Number.isNaN(p[f])) return `Campo faltando/ruim: ${f.toUpperCase()}.`;
      if(p[f] < 0) return `Campo negativo não permitido: ${f.toUpperCase()}.`;
    }
    return null;
  }

  function importMessage(){
    const raw = el("paste").value;
    if(!raw.trim()){ msg("Cole a mensagem do WhatsApp primeiro.", false); return; }

    const parsed = parseMessage(raw);
    const err = validateParsed(parsed);
    if(err){ msg("Erro na mensagem: " + err, false); return; }

    const db = loadDB();
    const id = makeEntryId(parsed.unit, parsed.date);

    const total = Number(parsed.pix)+Number(parsed.cash)+Number(parsed.credit)+Number(parsed.debit);

    db.entries[id] = {
      id,
      unit: parsed.unit,
      date: parsed.date,
      cars: Number(parsed.cars),
      pix: Number(parsed.pix),
      cash: Number(parsed.cash),
      credit: Number(parsed.credit),
      debit: Number(parsed.debit),
      total,
      raw,
      createdAt: new Date().toISOString()
    };

    // remove old prazo tx linked to this entry id (to allow re-import cleanly)
    db.prazoTx = db.prazoTx.filter(tx => tx.originEntryId !== id);

    // add prazo
    for(const tx of parsed.prazo){
      if(tx && tx._invalid) continue;
      db.prazoTx.push({
        id: cryptoRandomId(),
        unit: parsed.unit,
        date: parsed.date,
        client: normalizeClient(tx.client),
        type: tx.type,
        value: Number(tx.value),
        obs: String(tx.obs||""),
        originEntryId: id,
        createdAt: new Date().toISOString()
      });
    }

    saveDB(db);
    msg(`Importado: ${parsed.unit} / ${parsed.date} (prazo: ${parsed.prazo.filter(x=>!x._invalid).length})`, true);

    // refresh views
    el("paste").value = "";
    runQuery();
    renderPrazoTable();
  }

  function cryptoRandomId(){
    try{
      const a = new Uint32Array(4);
      crypto.getRandomValues(a);
      return Array.from(a).map(x=>x.toString(16)).join("");
    }catch(e){
      return String(Date.now()) + "_" + Math.random().toString(16).slice(2);
    }
  }

  function deleteEntry(entryId){
    const db = loadDB();
    if(!db.entries[entryId]) return;
    if(!confirm("Excluir este fechamento (e as notas a prazo dele)?")) return;

    delete db.entries[entryId];
    db.prazoTx = db.prazoTx.filter(tx => tx.originEntryId !== entryId);

    saveDB(db);
    msg("Excluído.", true);
    runQuery();
    renderPrazoTable();
    closeStatement();
  }

  function entriesInRange(db, start, end){
    // start/end inclusive, YYYY-MM-DD
    const res = [];
    for(const id in db.entries){
      const e = db.entries[id];
      if(e.date >= start && e.date <= end) res.push(e);
    }
    return res;
  }

  function sumEntries(entries){
    const sum = {
      cars:0, pix:0, cash:0, credit:0, debit:0, total:0
    };
    for(const e of entries){
      sum.cars += Number(e.cars||0);
      sum.pix += Number(e.pix||0);
      sum.cash += Number(e.cash||0);
      sum.credit += Number(e.credit||0);
      sum.debit += Number(e.debit||0);
      sum.total += Number(e.total||0);
    }
    return sum;
  }

  function groupByUnit(entries){
    const map = {};
    for(const u of UNITS){
      map[u] = { unit:u, cars:0, pix:0, cash:0, credit:0, debit:0, total:0 };
    }
    for(const e of entries){
      const u = e.unit;
      if(!map[u]) map[u] = { unit:u, cars:0, pix:0, cash:0, credit:0, debit:0, total:0 };
      map[u].cars += Number(e.cars||0);
      map[u].pix += Number(e.pix||0);
      map[u].cash += Number(e.cash||0);
      map[u].credit += Number(e.credit||0);
      map[u].debit += Number(e.debit||0);
      map[u].total += Number(e.total||0);
    }
    return Object.values(map);
  }

  function prazoMovInRange(db, start, end){
    // movement amount = sum of sales + payments (absolute movement) OR net? user asked apuração; show movement total
    let mov = 0;
    for(const tx of db.prazoTx){
      if(tx.date < start || tx.date > end) continue;
      mov += Number(tx.value||0);
    }
    return mov;
  }

  function runQuery(){
    const mode = el("mode").value;
    const db = loadDB();

    let start, end;
    if(mode==="DIA"){
      start = end = el("qDate").value || todayISO();
    }else{
      start = el("qStart").value || todayISO();
      end = el("qEnd").value || todayISO();
      if(end < start){ const tmp = start; start = end; end = tmp; }
    }

    const entries = entriesInRange(db, start, end);
    const sum = sumEntries(entries);
    const byUnit = groupByUnit(entries);
    const prazoMov = prazoMovInRange(db, start, end);

    // KPIs
    el("kCars").textContent = String(sum.cars);
    el("kTotal").textContent = fmtMoney(sum.total);
    el("kPrazoMov").textContent = fmtMoney(prazoMov);
    el("kPix").textContent = fmtMoney(sum.pix);
    el("kCash").textContent = fmtMoney(sum.cash);
    el("kCredit").textContent = fmtMoney(sum.credit);
    el("kDebit").textContent = fmtMoney(sum.debit);

    // unit table
    const tb = el("tblUnits");
    tb.innerHTML = "";
    for(const r of byUnit){
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td><b>${r.unit}</b></td>
        <td>${r.cars}</td>
        <td>${fmtMoney(r.pix)}</td>
        <td>${fmtMoney(r.cash)}</td>
        <td>${fmtMoney(r.credit)}</td>
        <td>${fmtMoney(r.debit)}</td>
        <td><b>${fmtMoney(r.total)}</b></td>
      `;
      tb.appendChild(tr);
    }

    // entries list table (show only in selected range; order by date desc then unit)
    const te = el("tblEntries");
    te.innerHTML = "";

    const sorted = entries.slice().sort((a,b)=>{
      if(a.date!==b.date) return a.date < b.date ? 1 : -1;
      return a.unit.localeCompare(b.unit);
    });

    if(!sorted.length){
      const tr = document.createElement("tr");
      tr.innerHTML = `<td colspan="5" class="small">Sem lançamentos no período.</td>`;
      te.appendChild(tr);
      return;
    }

    for(const e of sorted){
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${e.date}</td>
        <td><span class="tag">${e.unit}</span></td>
        <td>${e.cars}</td>
        <td><b>${fmtMoney(e.total)}</b></td>
        <td>
          <button class="btn danger" data-del="${e.id}">Excluir</button>
        </td>
      `;
      te.appendChild(tr);
    }

    te.querySelectorAll("button[data-del]").forEach(btn=>{
      btn.addEventListener("click", ()=> deleteEntry(btn.getAttribute("data-del")));
    });
  }

  // PRAZO — compute balances per client per unit
  function computePrazoBalances(db){
    // key: unit|client -> {client, unit, balance, lastDate}
    const map = new Map();
    for(const tx of db.prazoTx){
      const unit = tx.unit;
      const client = normalizeClient(tx.client);
      if(!unit || !client) continue;
      const key = unit + "|" + client.toUpperCase();
      if(!map.has(key)){
        map.set(key, { client, unit, balance:0, lastDate:tx.date, lastAt:tx.createdAt });
      }
      const row = map.get(key);
      const val = Number(tx.value||0);
      if(tx.type==="VENDA") row.balance += val;
      else if(tx.type==="PAGAMENTO") row.balance -= val;

      // track latest movement
      if(tx.date > row.lastDate) row.lastDate = tx.date;
      if(tx.createdAt && tx.createdAt > (row.lastAt||"")) row.lastAt = tx.createdAt;
    }
    return Array.from(map.values());
  }

  function renderPrazoTable(){
    const db = loadDB();
    const fUnit = el("fUnit").value;
    const fClient = (el("fClient").value||"").trim().toUpperCase();
    const fSaldo = el("fSaldo").value;

    const rows = computePrazoBalances(db);

    let filtered = rows;
    if(fUnit !== "TODAS") filtered = filtered.filter(r => r.unit === fUnit);
    if(fClient) filtered = filtered.filter(r => r.client.toUpperCase().includes(fClient));
    if(fSaldo==="DEVENDO") filtered = filtered.filter(r => r.balance > 0.000001);
    if(fSaldo==="QUITADO") filtered = filtered.filter(r => Math.abs(r.balance) < 0.000001);

    filtered.sort((a,b)=>{
      // devendo first, then by client
      const da = a.balance > 0 ? 0 : 1;
      const dbb = b.balance > 0 ? 0 : 1;
      if(da !== dbb) return da - dbb;
      if(a.client.toUpperCase() !== b.client.toUpperCase()) return a.client.localeCompare(b.client,"pt-BR");
      return a.unit.localeCompare(b.unit);
    });

    const tb = el("tblPrazo");
    tb.innerHTML = "";

    if(!filtered.length){
      const tr = document.createElement("tr");
      tr.innerHTML = `<td colspan="4" class="small">Nenhuma conta a prazo encontrada.</td>`;
      tb.appendChild(tr);
      return;
    }

    for(const r of filtered){
      const tr = document.createElement("tr");
      const saldo = r.balance;
      const saldoTxt = fmtMoney(saldo);
      tr.innerHTML = `
        <td><b>${r.client}</b></td>
        <td><span class="tag">${r.unit}</span></td>
        <td><b style="color:${saldo>0?'#c92a2a':'#2b8a3e'}">${saldoTxt}</b></td>
        <td>${r.lastDate}</td>
      `;
      tr.style.cursor = "pointer";
      tr.addEventListener("click", ()=> openStatement(r.unit, r.client));
      tb.appendChild(tr);
    }
  }

  function openStatement(unit, client){
    const db = loadDB();
    const c = normalizeClient(client);
    const u = unit;

    const txs = db.prazoTx
      .filter(t => t.unit===u && normalizeClient(t.client).toUpperCase()===c.toUpperCase())
      .sort((a,b)=>{
        if(a.date!==b.date) return a.date < b.date ? 1 : -1;
        return (a.createdAt||"") < (b.createdAt||"") ? 1 : -1;
      });

    el("clientStatementBox").style.display = "block";
    el("stClient").textContent = c;
    el("stUnit").textContent = u;

    const tb = el("tblStatement");
    tb.innerHTML = "";

    if(!txs.length){
      const tr = document.createElement("tr");
      tr.innerHTML = `<td colspan="5" class="small">Sem movimentações.</td>`;
      tb.appendChild(tr);
      return;
    }

    for(const t of txs){
      const tr = document.createElement("tr");
      const sign = t.type==="VENDA" ? "+" : "-";
      tr.innerHTML = `
        <td>${t.date}</td>
        <td><span class="tag">${t.type}</span></td>
        <td><b>${sign} ${fmtMoney(t.value)}</b></td>
        <td>${escapeHtml(t.obs||"")}</td>
        <td class="mono small">${t.originEntryId||""}</td>
      `;
      tb.appendChild(tr);
    }

    // bind clear client
    el("btnClearClient").onclick = ()=>{
      if(!confirm("Zerar a conta deste cliente nesta unidade? (apaga o histórico dele)")) return;
      const db2 = loadDB();
      db2.prazoTx = db2.prazoTx.filter(t => !(t.unit===u && normalizeClient(t.client).toUpperCase()===c.toUpperCase()));
      saveDB(db2);
      msg("Conta zerada (cliente).", true);
      renderPrazoTable();
      closeStatement();
    };
  }

  function closeStatement(){
    el("clientStatementBox").style.display = "none";
    el("tblStatement").innerHTML = "";
  }

  function escapeHtml(s){
    return String(s||"").replace(/[&<>"']/g, (ch)=>({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
    }[ch]));
  }

  // Backup: export JSON file
  function exportBackup(){
    const db = loadDB();
    const blob = new Blob([JSON.stringify(db, null, 2)], {type:"application/json"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = `backup-juliano-${todayISO()}.json`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  }

  // Backup: import JSON
  async function importBackupFromFile(file){
    const text = await file.text();
    let j;
    try{
      j = JSON.parse(text);
    }catch(e){
      msg("JSON inválido.", false);
      return;
    }
    if(!j || typeof j !== "object" || !j.entries || !Array.isArray(j.prazoTx)){
      msg("Backup não parece do sistema.", false);
      return;
    }
    if(!confirm("Importar backup vai substituir seus dados atuais. Continuar?")) return;
    localStorage.setItem(STORE_KEY, JSON.stringify(j));
    msg("Backup importado.", true);
    runQuery();
    renderPrazoTable();
    closeStatement();
  }

  function resetAll(){
    if(!confirm("ZERAR TUDO? Isso apaga lançamentos e contas a prazo.")) return;
    localStorage.removeItem(STORE_KEY);
    msg("Tudo zerado.", true);
    runQuery();
    renderPrazoTable();
    closeStatement();
  }

  // UI wiring
  el("btnImport").addEventListener("click", importMessage);
  el("btnClearPaste").addEventListener("click", ()=> el("paste").value="");
  el("btnExportJson").addEventListener("click", exportBackup);
  el("btnResetAll").addEventListener("click", resetAll);

  el("importJsonFile").addEventListener("change", (e)=>{
    const f = e.target.files && e.target.files[0];
    if(!f) return;
    importBackupFromFile(f);
    e.target.value = "";
  });

  el("mode").addEventListener("change", ()=>{
    const m = el("mode").value;
    const isDia = (m==="DIA");
    el("diaBox").style.display = isDia ? "" : "none";
    el("periodoBox").style.display = isDia ? "none" : "";
    el("periodoBox2").style.display = isDia ? "none" : "";
  });

  el("btnRun").addEventListener("click", runQuery);
  el("btnToday").addEventListener("click", ()=>{
    el("qDate").value = todayISO();
    el("qStart").value = todayISO();
    el("qEnd").value = todayISO();
    runQuery();
  });

  // prazo filters
  ["fUnit","fClient","fSaldo"].forEach(id=>{
    el(id).addEventListener("input", renderPrazoTable);
    el(id).addEventListener("change", renderPrazoTable);
  });

  // init defaults
  el("qDate").value = todayISO();
  el("qStart").value = todayISO();
  el("qEnd").value = todayISO();

  runQuery();
  renderPrazoTable();

})();
</script>
</body>
</html>
